<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üáßüá© Bangladesh Map Puzzle - FunLearnBD</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .screen {
            display: none;
            min-height: 100vh;
            padding: 20px;
            animation: fadeIn 0.4s ease;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ==================== HOME SCREEN ==================== */
        #homeScreen {
            text-align: center;
            padding-top: 30px;
        }

        .home-title {
            font-size: 2rem;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 5px;
        }

        .home-subtitle {
            color: rgba(255,255,255,0.9);
            font-size: 1rem;
            margin-bottom: 20px;
        }

        .mascot-container {
            position: relative;
            margin: 20px auto;
            width: 150px;
            height: 150px;
        }

        .mascot-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            animation: bounce 2s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .speech-bubble {
            position: absolute;
            top: -50px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 10px 15px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .speech-bubble:after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            border: 10px solid transparent;
            border-top-color: white;
        }

        .mode-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            max-width: 400px;
            margin: 20px auto;
        }

        .mode-card {
            background: white;
            border-radius: 20px;
            padding: 20px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .mode-card:active {
            transform: scale(0.95);
        }

        .mode-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .mode-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
        }

        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            color: white;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
        }

        .lang-toggle {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.2);
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            color: white;
            cursor: pointer;
        }

        .back-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255,255,255,0.2);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
        }

        /* ==================== LEARN MODE ==================== */
        .learn-container {
            max-width: 500px;
            margin: 0 auto;
            text-align: center;
            padding-top: 50px;
        }

        .learn-card {
            background: white;
            border-radius: 30px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        /* Intro card with full map */
        .learn-intro-map {
            width: 100%;
            max-width: 400px;
            margin: 0 auto 20px;
        }

        .learn-intro-text {
            font-size: 1.1rem;
            color: #555;
            line-height: 1.8;
            margin-bottom: 20px;
        }

        /* Division card with BIG centered image */
        .learn-piece-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        .learn-piece-img {
            width: 100%;
            max-width: 320px;
            height: auto;
        }

        .learn-division-name {
            font-size: 1.8rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 3px;
        }

        .learn-division-name-bn {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 12px;
        }

        .learn-fact {
            font-size: 1rem;
            color: #555;
            line-height: 1.5;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 15px;
            margin-bottom: 12px;
        }

        .audio-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            color: white;
            font-size: 1.3rem;
            cursor: pointer;
        }

        .learn-progress {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
        }

        .progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
        }

        .progress-dot.active {
            background: white;
            transform: scale(1.3);
        }

        .progress-dot.completed {
            background: #4ade80;
        }

        .learn-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .nav-btn {
            background: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .nav-btn:disabled {
            opacity: 0.5;
        }

        .nav-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        /* ==================== PUZZLE MODE ==================== */
        .puzzle-container {
            max-width: 900px;
            margin: 0 auto;
            padding-top: 50px;
        }

        .puzzle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            color: white;
        }

        .timer {
            font-size: 1.2rem;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
        }

        .progress-pills {
            display: flex;
            gap: 5px;
        }

        .progress-pill {
            width: 25px;
            height: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
        }

        .progress-pill.filled {
            background: #4ade80;
        }

        .complete-banner {
            display: none;
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 15px;
            text-align: center;
            color: white;
        }

        .complete-banner.show {
            display: block;
        }

        .play-again-btn {
            background: white;
            color: #22c55e;
            border: none;
            padding: 8px 20px;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
        }

        .puzzle-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        @media (min-width: 768px) {
            .puzzle-content {
                flex-direction: row;
            }
            .pieces-section {
                width: 250px;
            }
        }

        .map-section {
            flex: 1;
        }

        .map-wrapper {
            position: relative;
            background: white;
            border-radius: 20px;
            padding: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .map-background {
            width: 100%;
            height: auto;
            display: block;
        }

        .division-piece {
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            bottom: 15px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .division-piece img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .division-piece.placed {
            opacity: 1;
        }

        .pieces-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .piece-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: white;
            border: none;
            padding: 10px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .piece-btn:active {
            transform: scale(0.95);
        }

        .piece-btn.used {
            opacity: 0.4;
            pointer-events: none;
        }

        .piece-btn-thumb {
            width: 100%;
            max-width: 120px;
            height: auto;
            margin-bottom: 8px;
        }

        .piece-btn-name {
            font-weight: 600;
            font-size: 0.85rem;
            color: #333;
        }

        /* Fact Popup */
        .fact-popup {
            position: fixed;
            bottom: -250px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -5px 30px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 95%;
            transition: bottom 0.4s ease;
            z-index: 100;
        }

        .fact-popup.show {
            bottom: 0;
        }

        .fact-popup-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .fact-popup-mascot {
            width: 60px;
            height: 60px;
            object-fit: contain;
        }

        .fact-popup-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
        }

        .fact-popup-text {
            color: #555;
            line-height: 1.5;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .fact-popup-close {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 12px 30px;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            width: 100%;
            font-size: 1rem;
        }

        /* ==================== FIND MODE ==================== */
        .find-container {
            max-width: 600px;
            margin: 0 auto;
            text-align: center;
            padding-top: 50px;
        }

        .find-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            margin-bottom: 15px;
        }

        .lives-display {
            display: flex;
            gap: 5px;
        }

        .life-heart {
            font-size: 1.5rem;
        }

        .life-heart.lost {
            opacity: 0.3;
        }

        .find-question {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .find-mascot {
            width: 100px;
            height: 100px;
            object-fit: contain;
            margin-bottom: 10px;
        }

        .find-prompt {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 5px;
        }

        .find-target {
            font-size: 2rem;
            font-weight: 700;
            color: #764ba2;
        }

        .find-map-wrapper {
            background: white;
            border-radius: 20px;
            padding: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            cursor: pointer;
        }

        .find-map-wrapper img {
            width: 100%;
            display: block;
            border-radius: 10px;
        }

        .find-feedback {
            margin-top: 15px;
            padding: 15px;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: 600;
            display: none;
        }

        .find-feedback.correct {
            display: block;
            background: #dcfce7;
            color: #166534;
        }

        .find-feedback.wrong {
            display: block;
            background: #fee2e2;
            color: #991b1b;
        }

        /* ==================== QUIZ MODE ==================== */
        .quiz-container {
            max-width: 500px;
            margin: 0 auto;
            padding-top: 50px;
        }

        .quiz-header {
            display: flex;
            justify-content: space-between;
            color: white;
            margin-bottom: 20px;
            font-size: 1.1rem;
        }

        .quiz-card {
            background: white;
            border-radius: 25px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            text-align: center;
        }

        .quiz-mascot {
            width: 80px;
            height: 80px;
            object-fit: contain;
            margin-bottom: 15px;
        }

        .quiz-question {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        /* Image-based quiz options */
        .quiz-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .quiz-option {
            background: #f8f9fa;
            border: 3px solid #e0e0e0;
            padding: 15px 10px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .quiz-option:active {
            transform: scale(0.95);
        }

        .quiz-option-img {
            width: 100%;
            max-width: 150px;
            height: auto;
            margin-bottom: 10px;
        }

        .quiz-option-name {
            font-weight: 600;
            font-size: 1rem;
            color: #333;
        }

        .quiz-option.correct {
            background: #dcfce7;
            border-color: #4ade80;
        }

        .quiz-option.wrong {
            background: #fee2e2;
            border-color: #f87171;
        }

        .quiz-option.disabled {
            pointer-events: none;
        }

        .quiz-next-btn {
            display: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 12px 30px;
            border-radius: 20px;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 20px;
        }

        .quiz-next-btn.show {
            display: inline-block;
        }

        /* Result */
        .result-card {
            background: white;
            border-radius: 25px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .result-mascot {
            width: 120px;
            height: 120px;
            object-fit: contain;
            margin-bottom: 15px;
        }

        .result-title {
            font-size: 1.8rem;
            color: #333;
            margin-bottom: 10px;
        }

        .result-score {
            font-size: 3rem;
            font-weight: 700;
            color: #764ba2;
        }

        .result-stars {
            font-size: 2rem;
            margin: 15px 0;
        }

        .result-btns {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .result-btn {
            padding: 12px 25px;
            border-radius: 20px;
            border: none;
            font-size: 1rem;
            cursor: pointer;
        }

        .result-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .result-btn.secondary {
            background: #f0f0f0;
            color: #333;
        }

        /* Confetti */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            top: -10px;
            z-index: 1000;
            animation: fall linear forwards;
            pointer-events: none;
        }

        @keyframes fall {
            to { transform: translateY(100vh) rotate(720deg); }
        }
    </style>
</head>
<body>
    <!-- ==================== HOME SCREEN ==================== -->
    <div id="homeScreen" class="screen active">
        <button class="lang-toggle" onclick="toggleLanguage()">üåê EN/‡¶¨‡¶æ‡¶Ç</button>
        
        <h1 class="home-title">üáßüá© Bangladesh Map</h1>
        <p class="home-subtitle" id="homeSubtitle">Learn the 8 Divisions</p>

        <div class="mascot-container">
            <div class="speech-bubble" id="homeSpeech">Let's explore Bangladesh!</div>
            <img src="mascots/waving.png" alt="‡¶¨‡¶æ‡¶ò‡¶æ" class="mascot-img">
        </div>

        <div class="mode-grid">
            <div class="mode-card" onclick="startLearn()">
                <div class="mode-icon">üìö</div>
                <div class="mode-title" id="learnTitle">Learn</div>
            </div>
            <div class="mode-card" onclick="startPuzzle()">
                <div class="mode-icon">üß©</div>
                <div class="mode-title" id="puzzleTitle">Puzzle</div>
            </div>
            <div class="mode-card" onclick="startFind()">
                <div class="mode-icon">üéØ</div>
                <div class="mode-title" id="findTitle">Find</div>
            </div>
            <div class="mode-card" onclick="startQuiz()">
                <div class="mode-icon">‚ùì</div>
                <div class="mode-title" id="quizTitle">Quiz</div>
            </div>
        </div>

        <div class="stats-bar">
            <div class="stat-item">‚≠ê <span id="totalStars">0</span></div>
            <div class="stat-item">üèÜ <span id="completedModes">0</span>/4</div>
        </div>
    </div>

    <!-- ==================== LEARN SCREEN ==================== -->
    <div id="learnScreen" class="screen">
        <button class="back-btn" onclick="showScreen('homeScreen')">‚Üê</button>
        
        <div class="learn-container">
            <div class="learn-progress" id="learnProgress"></div>
            
            <div class="learn-card" id="learnCard"></div>

            <div class="learn-nav">
                <button class="nav-btn" id="learnPrevBtn" onclick="learnPrev()">‚Üê Previous</button>
                <button class="nav-btn primary" id="learnNextBtn" onclick="learnNext()">Next ‚Üí</button>
            </div>
        </div>
    </div>

    <!-- ==================== PUZZLE SCREEN ==================== -->
    <div id="puzzleScreen" class="screen">
        <button class="back-btn" onclick="showScreen('homeScreen')">‚Üê</button>
        
        <div class="puzzle-container">
            <div class="puzzle-header">
                <div class="timer" id="puzzleTimer">‚è±Ô∏è 0:00</div>
                <div class="progress-pills" id="puzzleProgress"></div>
            </div>

            <div class="complete-banner" id="completeBanner">
                <h3>üéâ Map Complete!</h3>
                <div id="completeStars"></div>
                <button class="play-again-btn" onclick="startPuzzle()">Play Again</button>
            </div>

            <div class="puzzle-content">
                <div class="map-section">
                    <div class="map-wrapper">
                        <img src="images/map_background.png" alt="Bangladesh" class="map-background">
                        <div class="division-piece" id="piece-rangpur"><img src="images/piece_rangpur.png" alt=""></div>
                        <div class="division-piece" id="piece-rajshahi"><img src="images/piece_rajshahi.png" alt=""></div>
                        <div class="division-piece" id="piece-mymensingh"><img src="images/piece_mymensingh.png" alt=""></div>
                        <div class="division-piece" id="piece-sylhet"><img src="images/piece_sylhet.png" alt=""></div>
                        <div class="division-piece" id="piece-dhaka"><img src="images/piece_dhaka.png" alt=""></div>
                        <div class="division-piece" id="piece-khulna"><img src="images/piece_khulna.png" alt=""></div>
                        <div class="division-piece" id="piece-barisal"><img src="images/piece_barisal.png" alt=""></div>
                        <div class="division-piece" id="piece-chittagong"><img src="images/piece_chittagong.png" alt=""></div>
                    </div>
                </div>
                <div class="pieces-section" id="piecesSection"></div>
            </div>
        </div>

        <div class="fact-popup" id="factPopup">
            <div class="fact-popup-header">
                <img src="mascots/talking.png" alt="‡¶¨‡¶æ‡¶ò‡¶æ" class="fact-popup-mascot">
                <div class="fact-popup-title" id="factPopupTitle"></div>
            </div>
            <div class="fact-popup-text" id="factPopupText"></div>
            <button class="fact-popup-close" onclick="closeFactPopup()">Got it!</button>
        </div>
    </div>

    <!-- ==================== FIND SCREEN ==================== -->
    <div id="findScreen" class="screen">
        <button class="back-btn" onclick="showScreen('homeScreen')">‚Üê</button>
        
        <div class="find-container">
            <div class="find-header">
                <div class="lives-display" id="livesDisplay"></div>
                <div>Score: <span id="findScore">0</span></div>
            </div>

            <div class="find-question">
                <img id="findMascot" src="mascots/talking.png" alt="‡¶¨‡¶æ‡¶ò‡¶æ" class="find-mascot">
                <div class="find-prompt">Can you find...</div>
                <div class="find-target" id="findTarget"></div>
            </div>

            <div class="find-map-wrapper" id="findMapWrapper">
                <img src="images/map_full.png" alt="Bangladesh Map" id="findMapImg">
            </div>

            <div class="find-feedback" id="findFeedback"></div>
        </div>
    </div>

    <!-- ==================== QUIZ SCREEN ==================== -->
    <div id="quizScreen" class="screen">
        <button class="back-btn" onclick="showScreen('homeScreen')">‚Üê</button>
        
        <div class="quiz-container">
            <div class="quiz-header">
                <div>Question <span id="quizQuestionNum">1</span>/10</div>
                <div>Score: <span id="quizScore">0</span></div>
            </div>

            <div class="quiz-card" id="quizCard">
                <img id="quizMascot" src="mascots/talking.png" alt="‡¶¨‡¶æ‡¶ò‡¶æ" class="quiz-mascot">
                <div class="quiz-question" id="quizQuestion"></div>
                <div class="quiz-options" id="quizOptions"></div>
                <button class="quiz-next-btn" id="quizNextBtn" onclick="nextQuizQuestion()">Next ‚Üí</button>
            </div>

            <div class="result-card" id="quizResult" style="display: none;">
                <img id="resultMascot" src="mascots/happy.png" alt="‡¶¨‡¶æ‡¶ò‡¶æ" class="result-mascot">
                <div class="result-title" id="resultTitle"></div>
                <div class="result-score" id="resultScore"></div>
                <div class="result-stars" id="resultStars"></div>
                <div class="result-btns">
                    <button class="result-btn secondary" onclick="showScreen('homeScreen')">üè† Home</button>
                    <button class="result-btn primary" onclick="startQuiz()">üîÑ Again</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== DATA ====================
        const DIVISIONS = {
            rangpur: { name: 'Rangpur', nameBn: '‡¶∞‡¶Ç‡¶™‡ßÅ‡¶∞', fact: { en: 'You can see Himalayan mountains on clear days!', bn: '‡¶™‡¶∞‡¶ø‡¶∑‡ßç‡¶ï‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶®‡ßá ‡¶π‡¶ø‡¶Æ‡¶æ‡¶≤‡¶Ø‡¶º ‡¶™‡¶∞‡ßç‡¶¨‡¶§ ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º!' }},
            rajshahi: { name: 'Rajshahi', nameBn: '‡¶∞‡¶æ‡¶ú‡¶∂‡¶æ‡¶π‡ßÄ', fact: { en: 'Famous for the sweetest mangoes!', bn: '‡¶∏‡¶¨‡¶ö‡ßá‡¶Ø‡¶º‡ßá ‡¶Æ‡¶ø‡¶∑‡ßç‡¶ü‡¶ø ‡¶Ü‡¶Æ‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¨‡¶ø‡¶ñ‡ßç‡¶Ø‡¶æ‡¶§!' }},
            mymensingh: { name: 'Mymensingh', nameBn: '‡¶Æ‡¶Ø‡¶º‡¶Æ‡¶®‡¶∏‡¶ø‡¶Ç‡¶π', fact: { en: 'Has the oldest Agricultural University!', bn: '‡¶∏‡¶¨‡¶ö‡ßá‡¶Ø‡¶º‡ßá ‡¶™‡ßÅ‡¶∞‡¶®‡ßã ‡¶ï‡ßÉ‡¶∑‡¶ø ‡¶¨‡¶ø‡¶∂‡ßç‡¶¨‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡¶Ø‡¶º ‡¶Ü‡¶õ‡ßá!' }},
            sylhet: { name: 'Sylhet', nameBn: '‡¶∏‡¶ø‡¶≤‡ßá‡¶ü', fact: { en: 'Home to beautiful tea gardens!', bn: '‡¶∏‡ßÅ‡¶®‡ßç‡¶¶‡¶∞ ‡¶ö‡¶æ ‡¶¨‡¶æ‡¶ó‡¶æ‡¶®‡ßá‡¶∞ ‡¶¶‡ßá‡¶∂!' }},
            dhaka: { name: 'Dhaka', nameBn: '‡¶¢‡¶æ‡¶ï‡¶æ', fact: { en: 'The capital with over 20 million people!', bn: '‡¶∞‡¶æ‡¶ú‡¶ß‡¶æ‡¶®‡ßÄ, ‡ß® ‡¶ï‡ßã‡¶ü‡¶ø‡¶∞‡¶ì ‡¶¨‡ßá‡¶∂‡¶ø ‡¶Æ‡¶æ‡¶®‡ßÅ‡¶∑!' }},
            khulna: { name: 'Khulna', nameBn: '‡¶ñ‡ßÅ‡¶≤‡¶®‡¶æ', fact: { en: 'Gateway to Sundarbans - home of tigers!', bn: '‡¶∏‡ßÅ‡¶®‡ßç‡¶¶‡¶∞‡¶¨‡¶®‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂‡¶¶‡ßç‡¶¨‡¶æ‡¶∞ - ‡¶¨‡¶æ‡¶ò‡ßá‡¶∞ ‡¶¨‡¶æ‡¶°‡¶º‡¶ø!' }},
            barisal: { name: 'Barisal', nameBn: '‡¶¨‡¶∞‡¶ø‡¶∂‡¶æ‡¶≤', fact: { en: 'Called Venice of the East for rivers!', bn: '‡¶®‡¶¶‡ßÄ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶æ‡¶ö‡ßç‡¶Ø‡ßá‡¶∞ ‡¶≠‡ßá‡¶®‡¶ø‡¶∏!' }},
            chittagong: { name: 'Chittagong', nameBn: '‡¶ö‡¶ü‡ßç‡¶ü‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ', fact: { en: "Has Cox's Bazar - world's longest beach!", bn: '‡¶ï‡¶ï‡ßç‡¶∏‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞ - ‡¶™‡ßÉ‡¶•‡¶ø‡¶¨‡ßÄ‡¶∞ ‡¶¶‡ßÄ‡¶∞‡ßç‡¶ò‡¶§‡¶Æ ‡¶∏‡ßà‡¶ï‡¶§!' }}
        };

        const DIVISION_ORDER = ['rangpur', 'rajshahi', 'mymensingh', 'sylhet', 'dhaka', 'khulna', 'barisal', 'chittagong'];

        const QUIZ_QUESTIONS = [
            { q: { en: "Which division has Cox's Bazar?", bn: "‡¶ï‡ßã‡¶® ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó‡ßá ‡¶ï‡¶ï‡ßç‡¶∏‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞?" }, a: 'chittagong' },
            { q: { en: "Which is the capital of Bangladesh?", bn: "‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶∞‡¶æ‡¶ú‡¶ß‡¶æ‡¶®‡ßÄ ‡¶ï‡ßã‡¶®‡¶ü‡¶ø?" }, a: 'dhaka' },
            { q: { en: "Which division is famous for mangoes?", bn: "‡¶ï‡ßã‡¶® ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó ‡¶Ü‡¶Æ‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¨‡¶ø‡¶ñ‡ßç‡¶Ø‡¶æ‡¶§?" }, a: 'rajshahi' },
            { q: { en: "Which division has the Sundarbans?", bn: "‡¶ï‡ßã‡¶® ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó‡ßá ‡¶∏‡ßÅ‡¶®‡ßç‡¶¶‡¶∞‡¶¨‡¶®?" }, a: 'khulna' },
            { q: { en: "Which division has tea gardens?", bn: "‡¶ï‡ßã‡¶® ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó‡ßá ‡¶ö‡¶æ ‡¶¨‡¶æ‡¶ó‡¶æ‡¶®?" }, a: 'sylhet' },
            { q: { en: "Where can you see Himalayan mountains?", bn: "‡¶ï‡ßã‡¶•‡¶æ ‡¶•‡ßá‡¶ï‡ßá ‡¶π‡¶ø‡¶Æ‡¶æ‡¶≤‡¶Ø‡¶º ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º?" }, a: 'rangpur' },
            { q: { en: "Which is called 'Venice of the East'?", bn: "‡¶ï‡ßã‡¶®‡¶ü‡¶ø '‡¶™‡ßç‡¶∞‡¶æ‡¶ö‡ßç‡¶Ø‡ßá‡¶∞ ‡¶≠‡ßá‡¶®‡¶ø‡¶∏'?" }, a: 'barisal' },
            { q: { en: "Which has the oldest Agricultural University?", bn: "‡¶∏‡¶¨‡¶ö‡ßá‡¶Ø‡¶º‡ßá ‡¶™‡ßÅ‡¶∞‡¶®‡ßã ‡¶ï‡ßÉ‡¶∑‡¶ø ‡¶¨‡¶ø‡¶∂‡ßç‡¶¨‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡¶Ø‡¶º ‡¶ï‡ßã‡¶•‡¶æ‡¶Ø‡¶º?" }, a: 'mymensingh' },
            { q: { en: "Which is the largest division?", bn: "‡¶∏‡¶¨‡¶ö‡ßá‡¶Ø‡¶º‡ßá ‡¶¨‡¶°‡¶º ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó ‡¶ï‡ßã‡¶®‡¶ü‡¶ø?" }, a: 'chittagong' },
            { q: { en: "Where do Royal Bengal Tigers live?", bn: "‡¶∞‡¶Ø‡¶º‡ßá‡¶≤ ‡¶¨‡ßá‡¶ô‡ßç‡¶ó‡¶≤ ‡¶ü‡¶æ‡¶á‡¶ó‡¶æ‡¶∞ ‡¶ï‡ßã‡¶•‡¶æ‡¶Ø‡¶º ‡¶•‡¶æ‡¶ï‡ßá?" }, a: 'khulna' }
        ];

        // ==================== STATE ====================
        let currentLang = 'en';
        let learnIndex = 0;
        let puzzleTimer = null;
        let puzzleSeconds = 0;
        let puzzlePlaced = 0;
        let findLives = 3;
        let findScore = 0;
        let findTarget = null;
        let findFound = [];
        let quizIndex = 0;
        let quizScore = 0;
        let quizQuestions = [];

        let progress = JSON.parse(localStorage.getItem('bdMapProgress') || '{"stars":0,"completed":[]}');

        // ==================== UTILITIES ====================
        function speak(text) {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                const clean = text.replace(/[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]|[\u{1F600}-\u{1F64F}]|[\u{1F680}-\u{1F6FF}]/gu, '');
                const u = new SpeechSynthesisUtterance(clean);
                u.lang = currentLang === 'bn' ? 'bn-BD' : 'en-US';
                u.rate = 0.9;
                speechSynthesis.speak(u);
            }
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if (id === 'homeScreen') updateStats();
        }

        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'bn' : 'en';
            updateLanguage();
        }

        function updateLanguage() {
            document.getElementById('homeSubtitle').textContent = currentLang === 'en' ? 'Learn the 8 Divisions' : '‡ßÆ‡¶ü‡¶ø ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó ‡¶∂‡¶ø‡¶ñ‡ßÅ‡¶®';
            document.getElementById('homeSpeech').textContent = currentLang === 'en' ? "Let's explore Bangladesh!" : '‡¶ö‡¶≤‡ßã ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂ ‡¶ò‡ßÅ‡¶∞‡ßá ‡¶¶‡ßá‡¶ñ‡¶ø!';
            document.getElementById('learnTitle').textContent = currentLang === 'en' ? 'Learn' : '‡¶∂‡¶ø‡¶ñ‡ßÅ‡¶®';
            document.getElementById('puzzleTitle').textContent = currentLang === 'en' ? 'Puzzle' : '‡¶™‡¶æ‡¶ú‡¶≤';
            document.getElementById('findTitle').textContent = currentLang === 'en' ? 'Find' : '‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßã';
            document.getElementById('quizTitle').textContent = currentLang === 'en' ? 'Quiz' : '‡¶ï‡ßÅ‡¶á‡¶ú';
        }

        function updateStats() {
            document.getElementById('totalStars').textContent = progress.stars;
            document.getElementById('completedModes').textContent = progress.completed.length;
        }

        function saveProgress() {
            localStorage.setItem('bdMapProgress', JSON.stringify(progress));
            updateStats();
        }

        function addStars(n) {
            progress.stars += n;
            saveProgress();
        }

        function confetti() {
            const colors = ['#667eea', '#764ba2', '#f1c40f', '#e74c3c', '#2ecc71'];
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const c = document.createElement('div');
                    c.className = 'confetti';
                    c.style.left = Math.random() * 100 + 'vw';
                    c.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    c.style.animationDuration = (Math.random() * 2 + 2) + 's';
                    document.body.appendChild(c);
                    setTimeout(() => c.remove(), 4000);
                }, i * 30);
            }
        }

        // ==================== LEARN MODE ====================
        function startLearn() {
            showScreen('learnScreen');
            learnIndex = 0;
            renderLearnProgress();
            renderLearnCard();
        }

        function renderLearnProgress() {
            const div = document.getElementById('learnProgress');
            div.innerHTML = '';
            // 9 dots: 1 intro + 8 divisions
            for (let i = 0; i < 9; i++) {
                const dot = document.createElement('div');
                dot.className = 'progress-dot' + (i === learnIndex ? ' active' : '') + (i < learnIndex ? ' completed' : '');
                div.appendChild(dot);
            }
        }

        function renderLearnCard() {
            const card = document.getElementById('learnCard');
            
            if (learnIndex === 0) {
                // Intro card
                card.innerHTML = `
                    <img src="images/map_full.png" alt="Bangladesh" class="learn-intro-map">
                    <div class="learn-intro-text">
                        ${currentLang === 'en' ? 
                            "Hey kids! üéâ<br><br>This is <strong>Bangladesh</strong> - our beautiful country! üáßüá©<br><br>Bangladesh has <strong>8 divisions</strong>:<br>Rangpur, Rajshahi, Mymensingh, Sylhet, Dhaka, Khulna, Barisal, and Chittagong.<br><br>Which division are YOU from? Let's learn about each one!" :
                            "‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶∞‡¶æ! üéâ<br><br>‡¶è‡¶ü‡¶æ ‡¶π‡¶≤‡ßã <strong>‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂</strong> - ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶∏‡ßÅ‡¶®‡ßç‡¶¶‡¶∞ ‡¶¶‡ßá‡¶∂! üáßüá©<br><br>‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá <strong>‡ßÆ‡¶ü‡¶ø ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó</strong> ‡¶Ü‡¶õ‡ßá:<br>‡¶∞‡¶Ç‡¶™‡ßÅ‡¶∞, ‡¶∞‡¶æ‡¶ú‡¶∂‡¶æ‡¶π‡ßÄ, ‡¶Æ‡¶Ø‡¶º‡¶Æ‡¶®‡¶∏‡¶ø‡¶Ç‡¶π, ‡¶∏‡¶ø‡¶≤‡ßá‡¶ü, ‡¶¢‡¶æ‡¶ï‡¶æ, ‡¶ñ‡ßÅ‡¶≤‡¶®‡¶æ, ‡¶¨‡¶∞‡¶ø‡¶∂‡¶æ‡¶≤ ‡¶è‡¶¨‡¶Ç ‡¶ö‡¶ü‡ßç‡¶ü‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ‡•§<br><br>‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶ï‡ßã‡¶® ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó ‡¶•‡ßá‡¶ï‡ßá? ‡¶ö‡¶≤‡ßã ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá ‡¶ú‡¶æ‡¶®‡¶ø!"}
                    </div>
                    <button class="audio-btn" onclick="speakIntro()">üîä</button>
                `;
            } else {
                // Division card - use DISPLAY images (cropped, big)
                const divId = DIVISION_ORDER[learnIndex - 1];
                const div = DIVISIONS[divId];
                card.innerHTML = `
                    <div class="learn-piece-container">
                        <img src="images/${divId}_display.png" alt="${div.name}" class="learn-piece-img">
                    </div>
                    <div class="learn-division-name">${div.name}</div>
                    <div class="learn-division-name-bn">${div.nameBn}</div>
                    <div class="learn-fact">${currentLang === 'en' ? div.fact.en : div.fact.bn}</div>
                    <button class="audio-btn" onclick="speakDivision('${divId}')">üîä</button>
                `;
            }

            // Update nav buttons
            document.getElementById('learnPrevBtn').disabled = learnIndex === 0;
            document.getElementById('learnNextBtn').textContent = learnIndex === 8 ? '‚úì Finish' : 'Next ‚Üí';

            renderLearnProgress();
        }

        function speakIntro() {
            speak(currentLang === 'en' ? 
                "Hey kids! This is Bangladesh, our beautiful country! Bangladesh has 8 divisions. Which division are you from?" :
                "‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶∞‡¶æ! ‡¶è‡¶ü‡¶æ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂, ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶∏‡ßÅ‡¶®‡ßç‡¶¶‡¶∞ ‡¶¶‡ßá‡¶∂! ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá ‡ßÆ‡¶ü‡¶ø ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó ‡¶Ü‡¶õ‡ßá‡•§ ‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶ï‡ßã‡¶® ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó ‡¶•‡ßá‡¶ï‡ßá?");
        }

        function speakDivision(divId) {
            const div = DIVISIONS[divId];
            // Say NAME first, then fact
            const text = currentLang === 'en' ? 
                `${div.name}. ${div.fact.en}` : 
                `${div.nameBn}‡•§ ${div.fact.bn}`;
            speak(text);
        }

        function learnPrev() {
            if (learnIndex > 0) {
                learnIndex--;
                renderLearnCard();
            }
        }

        function learnNext() {
            if (learnIndex < 8) {
                learnIndex++;
                renderLearnCard();
            } else {
                if (!progress.completed.includes('learn')) {
                    progress.completed.push('learn');
                    addStars(2);
                }
                speak(currentLang === 'en' ? 'Great job! You learned all divisions!' : '‡¶ö‡¶Æ‡ßé‡¶ï‡¶æ‡¶∞! ‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶∏‡¶¨ ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó ‡¶∂‡¶ø‡¶ñ‡ßá‡¶õ‡ßã!');
                showScreen('homeScreen');
            }
        }

        // ==================== PUZZLE MODE ====================
        function startPuzzle() {
            showScreen('puzzleScreen');
            puzzlePlaced = 0;
            puzzleSeconds = 0;
            
            document.querySelectorAll('#puzzleScreen .division-piece').forEach(p => p.classList.remove('placed'));
            document.getElementById('completeBanner').classList.remove('show');

            // Build piece buttons with bigger images
            const section = document.getElementById('piecesSection');
            section.innerHTML = '';
            const shuffled = [...DIVISION_ORDER].sort(() => Math.random() - 0.5);
            shuffled.forEach(divId => {
                const div = DIVISIONS[divId];
                const btn = document.createElement('button');
                btn.className = 'piece-btn';
                btn.id = `btn-${divId}`;
                btn.onclick = () => placePiece(divId);
                btn.innerHTML = `
                    <img src="images/${divId}_display.png" alt="${div.name}" class="piece-btn-thumb">
                    <span class="piece-btn-name">${currentLang === 'en' ? div.name : div.nameBn}</span>
                `;
                section.appendChild(btn);
            });

            // Progress pills
            const pills = document.getElementById('puzzleProgress');
            pills.innerHTML = '';
            for (let i = 0; i < 8; i++) {
                const pill = document.createElement('div');
                pill.className = 'progress-pill';
                pills.appendChild(pill);
            }

            // Timer
            if (puzzleTimer) clearInterval(puzzleTimer);
            puzzleTimer = setInterval(() => {
                puzzleSeconds++;
                const m = Math.floor(puzzleSeconds / 60);
                const s = puzzleSeconds % 60;
                document.getElementById('puzzleTimer').textContent = `‚è±Ô∏è ${m}:${s.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function placePiece(divId) {
            document.getElementById(`piece-${divId}`).classList.add('placed');
            document.getElementById(`btn-${divId}`).classList.add('used');
            puzzlePlaced++;
            document.querySelectorAll('.progress-pill')[puzzlePlaced - 1].classList.add('filled');

            // Show fact popup - say NAME first
            const div = DIVISIONS[divId];
            document.getElementById('factPopupTitle').textContent = currentLang === 'en' ? div.name : div.nameBn;
            document.getElementById('factPopupText').textContent = currentLang === 'en' ? div.fact.en : div.fact.bn;
            document.getElementById('factPopup').classList.add('show');
            
            // Speak: NAME first, then fact
            speak((currentLang === 'en' ? div.name : div.nameBn) + '. ' + (currentLang === 'en' ? div.fact.en : div.fact.bn));

            if (puzzlePlaced === 8) {
                clearInterval(puzzleTimer);
                setTimeout(() => {
                    closeFactPopup();
                    puzzleComplete();
                }, 2500);
            }
        }

        function closeFactPopup() {
            document.getElementById('factPopup').classList.remove('show');
        }

        function puzzleComplete() {
            let stars = puzzleSeconds < 45 ? 3 : puzzleSeconds < 90 ? 2 : 1;
            document.getElementById('completeStars').textContent = '‚≠ê'.repeat(stars);
            document.getElementById('completeBanner').classList.add('show');
            confetti();
            if (!progress.completed.includes('puzzle')) progress.completed.push('puzzle');
            addStars(stars);
            speak(currentLang === 'en' ? 'Amazing! You completed the map!' : '‡¶Ö‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£! ‡¶Æ‡¶æ‡¶®‡¶ö‡¶ø‡¶§‡ßç‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£!');
        }

        // ==================== FIND MODE ====================
        function startFind() {
            showScreen('findScreen');
            findLives = 3;
            findScore = 0;
            findFound = [];
            document.getElementById('findScore').textContent = '0';
            updateLives();
            
            // Add click handler to map
            const mapWrapper = document.getElementById('findMapWrapper');
            mapWrapper.onclick = handleMapClick;
            
            nextFindTarget();
        }

        function updateLives() {
            const div = document.getElementById('livesDisplay');
            div.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                const h = document.createElement('span');
                h.className = 'life-heart' + (i >= findLives ? ' lost' : '');
                h.textContent = '‚ù§Ô∏è';
                div.appendChild(h);
            }
        }

        function nextFindTarget() {
            const available = DIVISION_ORDER.filter(d => !findFound.includes(d));
            if (available.length === 0) {
                if (!progress.completed.includes('find')) progress.completed.push('find');
                addStars(3);
                confetti();
                speak(currentLang === 'en' ? 'Amazing! You found all divisions!' : '‡¶Ö‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£! ‡¶∏‡¶¨ ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó ‡¶™‡ßá‡¶Ø‡¶º‡ßá ‡¶ó‡ßá‡¶õ‡ßã!');
                setTimeout(() => showScreen('homeScreen'), 2000);
                return;
            }
            
            findTarget = available[Math.floor(Math.random() * available.length)];
            const div = DIVISIONS[findTarget];
            document.getElementById('findTarget').textContent = currentLang === 'en' ? div.name : div.nameBn;
            document.getElementById('findMascot').src = 'mascots/talking.png';
            document.getElementById('findFeedback').className = 'find-feedback';
            document.getElementById('findFeedback').textContent = '';
            
            speak(currentLang === 'en' ? `Find ${div.name}!` : `${div.nameBn} ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßã!`);
        }

        // Detect which division was clicked based on coordinates
        // These regions are based on the 3D isometric map layout
        function getDivisionAtPoint(xPct, yPct) {
            // Define clickable regions as polygons (percentage-based)
            // Order matters - more specific regions first
            
            // Rangpur: top-left area (red)
            if (xPct >= 8 && xPct <= 30 && yPct >= 5 && yPct <= 35) return 'rangpur';
            
            // Mymensingh: top-center (pink)
            if (xPct >= 28 && xPct <= 45 && yPct >= 10 && yPct <= 38) return 'mymensingh';
            
            // Sylhet: top-right (teal/green)
            if (xPct >= 42 && xPct <= 65 && yPct >= 5 && yPct <= 35) return 'sylhet';
            
            // Rajshahi: left-middle area (yellow)
            if (xPct >= 5 && xPct <= 32 && yPct >= 32 && yPct <= 58) return 'rajshahi';
            
            // Dhaka: center (light blue)
            if (xPct >= 35 && xPct <= 55 && yPct >= 35 && yPct <= 60) return 'dhaka';
            
            // Barisal: bottom-center (pink/lavender)
            if (xPct >= 42 && xPct <= 58 && yPct >= 55 && yPct <= 85) return 'barisal';
            
            // Chittagong: right side (green, largest)
            if (xPct >= 55 && xPct <= 95 && yPct >= 30 && yPct <= 95) return 'chittagong';
            
            // Khulna: bottom-left (cream/beige) - checked last, wider area
            if (xPct >= 5 && xPct <= 45 && yPct >= 55 && yPct <= 98) return 'khulna';
            
            return null;
        }

        function handleMapClick(e) {
            const img = document.getElementById('findMapImg');
            const rect = img.getBoundingClientRect();
            
            // Calculate click position as percentage
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const xPct = (x / rect.width) * 100;
            const yPct = (y / rect.height) * 100;
            
            const clickedDiv = getDivisionAtPoint(xPct, yPct);
            
            if (clickedDiv) {
                checkFindAnswer(clickedDiv);
            }
        }

        function checkFindAnswer(divId) {
            const feedback = document.getElementById('findFeedback');
            
            if (divId === findTarget) {
                findFound.push(divId);
                findScore += 10;
                document.getElementById('findScore').textContent = findScore;
                document.getElementById('findMascot').src = 'mascots/happy.png';
                feedback.className = 'find-feedback correct';
                feedback.textContent = currentLang === 'en' ? '‚úì Correct! Great job!' : '‚úì ‡¶∏‡¶†‡¶ø‡¶ï! ‡¶ö‡¶Æ‡ßé‡¶ï‡¶æ‡¶∞!';
                speak(currentLang === 'en' ? 'Correct!' : '‡¶∏‡¶†‡¶ø‡¶ï!');
                
                setTimeout(nextFindTarget, 1200);
            } else {
                findLives--;
                updateLives();
                document.getElementById('findMascot').src = 'mascots/sad.png';
                feedback.className = 'find-feedback wrong';
                const correctName = DIVISIONS[findTarget][currentLang === 'en' ? 'name' : 'nameBn'];
                feedback.textContent = currentLang === 'en' ? `‚úó That's not ${correctName}. Try again!` : `‚úó ‡¶è‡¶ü‡¶æ ${correctName} ‡¶®‡¶æ‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßã!`;
                speak(currentLang === 'en' ? 'Try again!' : '‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßã!');
                
                if (findLives <= 0) {
                    setTimeout(() => {
                        if (findScore >= 50) {
                            if (!progress.completed.includes('find')) progress.completed.push('find');
                            addStars(2);
                        }
                        speak(currentLang === 'en' ? 'Game over!' : '‡¶ó‡ßá‡¶Æ ‡¶∂‡ßá‡¶∑!');
                        showScreen('homeScreen');
                    }, 1500);
                }
            }
        }

        // ==================== QUIZ MODE ====================
        function startQuiz() {
            showScreen('quizScreen');
            quizIndex = 0;
            quizScore = 0;
            document.getElementById('quizScore').textContent = '0';
            document.getElementById('quizCard').style.display = 'block';
            document.getElementById('quizResult').style.display = 'none';
            quizQuestions = [...QUIZ_QUESTIONS].sort(() => Math.random() - 0.5).slice(0, 10);
            showQuizQuestion();
        }

        function showQuizQuestion() {
            const q = quizQuestions[quizIndex];
            document.getElementById('quizQuestionNum').textContent = quizIndex + 1;
            document.getElementById('quizQuestion').textContent = currentLang === 'en' ? q.q.en : q.q.bn;
            document.getElementById('quizMascot').src = 'mascots/talking.png';
            document.getElementById('quizNextBtn').classList.remove('show');

            // Generate 4 image options
            let options = [q.a];
            while (options.length < 4) {
                const r = DIVISION_ORDER[Math.floor(Math.random() * DIVISION_ORDER.length)];
                if (!options.includes(r)) options.push(r);
            }
            options.sort(() => Math.random() - 0.5);

            const optDiv = document.getElementById('quizOptions');
            optDiv.innerHTML = '';
            options.forEach(divId => {
                const div = DIVISIONS[divId];
                const btn = document.createElement('button');
                btn.className = 'quiz-option';
                btn.onclick = () => checkQuizAnswer(divId, btn, q.a);
                btn.innerHTML = `
                    <img src="images/${divId}_display.png" alt="${div.name}" class="quiz-option-img">
                    <span class="quiz-option-name">${currentLang === 'en' ? div.name : div.nameBn}</span>
                `;
                optDiv.appendChild(btn);
            });
        }

        function checkQuizAnswer(selected, btn, correct) {
            document.querySelectorAll('.quiz-option').forEach(b => b.classList.add('disabled'));
            
            if (selected === correct) {
                btn.classList.add('correct');
                document.getElementById('quizMascot').src = 'mascots/happy.png';
                quizScore += 10;
                document.getElementById('quizScore').textContent = quizScore;
            } else {
                btn.classList.add('wrong');
                document.getElementById('quizMascot').src = 'mascots/sad.png';
                document.querySelectorAll('.quiz-option').forEach(b => {
                    const img = b.querySelector('img');
                    if (img.src.includes(correct)) b.classList.add('correct');
                });
            }
            
            document.getElementById('quizNextBtn').classList.add('show');
        }

        function nextQuizQuestion() {
            quizIndex++;
            if (quizIndex < quizQuestions.length) {
                showQuizQuestion();
            } else {
                showQuizResult();
            }
        }

        function showQuizResult() {
            document.getElementById('quizCard').style.display = 'none';
            document.getElementById('quizResult').style.display = 'block';
            
            const pct = quizScore / 100 * 100;
            let stars = pct >= 80 ? 3 : pct >= 50 ? 2 : 1;
            let title = pct >= 80 ? (currentLang === 'en' ? 'Amazing!' : '‡¶Ö‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£!') : 
                        pct >= 50 ? (currentLang === 'en' ? 'Well done!' : '‡¶¨‡¶æ‡¶π!') : 
                        (currentLang === 'en' ? 'Good try!' : '‡¶≠‡¶æ‡¶≤‡ßã ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ!');
            
            document.getElementById('resultMascot').src = pct >= 50 ? 'mascots/happy.png' : 'mascots/talking.png';
            document.getElementById('resultTitle').textContent = title;
            document.getElementById('resultScore').textContent = quizScore + '/100';
            document.getElementById('resultStars').textContent = '‚≠ê'.repeat(stars);
            
            if (pct >= 80) confetti();
            if (!progress.completed.includes('quiz')) progress.completed.push('quiz');
            addStars(stars);
        }

        // ==================== INIT ====================
        updateStats();
        updateLanguage();
        setTimeout(() => speak(currentLang === 'en' ? "Hello! I'm Bagha. Let's explore Bangladesh!" : "‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã! ‡¶Ü‡¶Æ‡¶ø ‡¶¨‡¶æ‡¶ò‡¶æ‡•§ ‡¶ö‡¶≤‡ßã ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂ ‡¶ò‡ßÅ‡¶∞‡ßá ‡¶¶‡ßá‡¶ñ‡¶ø!"), 500);
    </script>
</body>
</html>
